<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Battle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    .box {
      background: #020617;
      border-radius: 10px;
      padding: 20px;
      max-width: 520px;
      margin: 40px auto;
      box-shadow: 0 0 15px rgba(0,0,0,.6);
    }
    h2 { margin-bottom: 10px; }

    .option {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      font-weight: 500;
      border: 2px solid transparent;
    }
    .option:hover:not(:disabled) {
      background: #334155;
    }
    .option:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .correct { background: #22c55e !important; color: white !important; border-color: #16a34a !important; }
    .wrong { background: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
    .selected { border: 3px solid #60a5fa !important; box-shadow: 0 0 12px #60a5fa; }

    #timer { font-size: 18px; margin: 15px 0; color: #38bdf8; }
    #result { margin-top: 15px; font-size: 19px; min-height: 30px; font-weight: bold; color: #fbbf24; }
    #opponent { color: #fb923c; min-height: 22px; margin: 8px 0; font-weight: bold; }
    #scores { margin-top: 20px; font-size: 18px; display: none; font-weight: bold; color: #a3e635; }
    .debug { font-size: 11px; color: #64748b; margin-top: 15px; }
    .error-msg { color: #ef4444; font-size: 16px; font-weight: bold; margin: 20px 0; }
    .player-info { 
      background: #1e293b; 
      padding: 12px; 
      border-radius: 8px; 
      margin: 10px 0; 
      border-left: 4px solid #3b82f6;
    }
    .waiting-status {
      color: #fbbf24;
      font-size: 14px;
      margin: 10px 0;
      font-style: italic;
    }
    .players-list {
      margin: 15px 0;
      padding: 10px;
      background: #1e293b;
      border-radius: 8px;
    }
    .player-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      margin: 5px 0;
      background: #334155;
      border-radius: 6px;
    }
    .player-badge {
      background: #3b82f6;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>Quiz Battle üéØ</h2>

  <div>Room Code: <b id="room"></b></div>
  
  <div class="player-info">
    <div>B·∫°n: <b id="username">-</b></div>
    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">User ID: <span id="userId">-</span></div>
  </div>

  <div class="players-list" id="playersList" style="display: none;">
    <div style="font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Ng∆∞·ªùi ch∆°i trong ph√≤ng:</div>
    <div id="playersContainer"></div>
  </div>

  <div class="waiting-status" id="waitingStatus"></div>

  <hr>

  <div id="question" aria-live="assertive">ƒêang k·∫øt n·ªëi...</div>
  <div id="timer" aria-live="polite"></div>

  <button class="option" id="btnA" onclick="sendAnswer('A')"></button>
  <button class="option" id="btnB" onclick="sendAnswer('B')"></button>
  <button class="option" id="btnC" onclick="sendAnswer('C')"></button>
  <button class="option" id="btnD" onclick="sendAnswer('D')"></button>

  <div id="opponent" aria-live="polite"></div>
  <div id="result" aria-live="polite"></div>
  <div id="scores"></div>
  
  <div class="debug" id="debug">Connecting...</div>
</div>

<script>
const roomCode = window.location.pathname.split("/").filter(Boolean).pop();
document.getElementById("room").innerText = roomCode || "Unknown";

let socket;
let myUserId = null;
let myUsername = null;
let currentQuestionNum = 0;
let timerInterval = null;
let answered = false;
let myAnswer = null;
let playersInRoom = new Map(); // Map<user_id, username>
let opponentUsername = null;

function debug(msg) {
  console.log("Debug: " + msg);
  document.getElementById("debug").innerText = msg;
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showError(message) {
  document.getElementById("question").innerHTML = `<div class="error-msg">‚ùå ${message}</div>`;
  enableButtons(false);
  document.getElementById("timer").innerText = "";
}

function updatePlayersList() {
  const container = document.getElementById("playersContainer");
  const playersList = document.getElementById("playersList");
  
  if (playersInRoom.size === 0) {
    playersList.style.display = "none";
    return;
  }
  
  playersList.style.display = "block";
  container.innerHTML = "";
  
  playersInRoom.forEach((username, userId) => {
    const isMe = userId === myUserId;
    const div = document.createElement("div");
    div.className = "player-item";
    div.innerHTML = `
      <span>${username}</span>
      ${isMe ? '<span class="player-badge">B·∫†N</span>' : ''}
    `;
    container.appendChild(div);
  });
}

function updateWaitingStatus() {
  const status = document.getElementById("waitingStatus");
  if (playersInRoom.size < 2) {
    status.innerText = `‚è≥ ƒêang ch·ªù ng∆∞·ªùi ch∆°i th·ª© ${3 - playersInRoom.size}...`;
    status.style.display = "block";
  } else {
    status.style.display = "none";
  }
}

function connect() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const csrftoken = getCookie('csrftoken');
  const sessionid = getCookie('sessionid');
  
  // G·ª≠i session cookie qua query string (ho·∫∑c headers n·∫øu browser h·ªó tr·ª£)
  const wsUrl = `${protocol}//${window.location.host}/ws/quiz/${roomCode}/`;
  
  socket = new WebSocket(wsUrl);

  socket.onopen = () => {
    debug("Connected - waiting for authentication...");
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("WS:", data);

    switch (data.type) {
      case "error":
        showError(data.message || "C√≥ l·ªói x·∫£y ra");
        debug("Error: " + (data.message || "Unknown error"));
        break;

      case "no_room":
        showError("Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
        debug("Room not found");
        break;

      case "joined":
        myUserId = data.user_id;
        myUsername = data.username;
        document.getElementById("username").innerText = myUsername;
        document.getElementById("userId").innerText = myUserId;
        
        playersInRoom.set(myUserId, myUsername);
        
        // Add other players already in room
        if (data.other_players && data.other_players.length > 0) {
          data.other_players.forEach(player => {
            playersInRoom.set(player.user_id, player.username);
            opponentUsername = player.username;
          });
        }
        
        updatePlayersList();
        updateWaitingStatus();
        
        document.getElementById("question").innerText = "ƒêang ch·ªù ng∆∞·ªùi ch∆°i kh√°c...";
        debug(`Joined as ${myUsername} (${data.player_count}/2)`);
        break;

      case "player_joined":
        if (data.user_id !== myUserId) {
          playersInRoom.set(data.user_id, data.username);
          opponentUsername = data.username;
          updatePlayersList();
          updateWaitingStatus();
          
          document.getElementById("question").innerText = 
            `${data.username} ƒë√£ tham gia! Tr·∫≠n ƒë·∫•u s·∫Øp b·∫Øt ƒë·∫ßu...`;
          debug(`Player joined: ${data.username}`);
        }
        break;

      case "start":
        startQuestion(data);
        break;

      case "player_answered":
        if (data.user_id !== myUserId && !answered) {
          const username = data.username || playersInRoom.get(data.user_id) || "ƒê·ªëi th·ªß";
          document.getElementById("opponent").innerText = `‚ö° ${username} ƒë√£ tr·∫£ l·ªùi!`;
        }
        break;

      case "stop_timer":
        debug(`Timer stopped by server: ${data.reason}`);
        stopClientTimer();
        document.getElementById("timer").innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
        break;

      case "result":
        if (data.question_num >= currentQuestionNum) {
          currentQuestionNum = data.question_num;
          showResult(data);
        }
        break;

      case "finished":
        showFinalResult(data);
        break;
    }
  };

  socket.onerror = (error) => {
    console.error("WebSocket error:", error);
    debug("Connection error");
  };

  socket.onclose = (event) => {
    debug(`Disconnected (${event.code}) - reconnecting...`);
    
    // Code 4001 = authentication failed
    if (event.code === 4001) {
      showError("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.");
      return;
    }
    
    setTimeout(connect, 3000);
  };
}

function startQuestion(data) {
  debug(`Starting question ${data.question_num}`);
  currentQuestionNum = data.question_num;
  answered = false;
  myAnswer = null;

  // Clear any existing timer before starting a new one
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  document.getElementById("question").innerText = `C√¢u ${data.question_num}: ${data.question.text}`;

  ["A","B","C","D"].forEach(l => {
    setBtn(l, data.question[l.toLowerCase()] || "");
    const btn = document.getElementById("btn" + l);
    btn.classList.remove("correct", "wrong", "selected");
  });

  document.getElementById("result").innerText = "";
  document.getElementById("opponent").innerText = "";
  document.getElementById("scores").style.display = "none";
  document.getElementById("timer").innerText = "";

  enableButtons(true);
  startTimer(data.timer || 30);
}

function startTimer(seconds) {
    // ALWAYS clear old timer first
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    // Initialize timer with a unique ID to prevent old intervals from interfering
    const startTime = Date.now();
    const timerDuration = seconds * 1000;
    const timerElement = document.getElementById("timer");
    
    // Display initial time
    timerElement.innerText = `‚è± ${seconds}s`;

    // Create NEW timer
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = Math.max(0, seconds - elapsed);
        
        timerElement.innerText = `‚è± ${remaining}s`;

        if (remaining <= 0) {
            // Clear THIS interval immediately
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerElement.innerText = "‚è∞ H·∫øt gi·ªù!";
            enableButtons(false);
            
            if (!answered) {
                myAnswer = null;
                document.getElementById("result").innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            }
        }
    }, 500); // Check every 500ms for better accuracy
}

function sendAnswer(letter) {
  if (answered) return;

  answered = true;
  myAnswer = letter;

  clearInterval(timerInterval);
  timerInterval = null;
  document.getElementById("timer").innerText = "‚è≥ ƒêang ch·ªù...";

  ["A","B","C","D"].forEach(l => document.getElementById("btn" + l).classList.remove("selected"));
  document.getElementById("btn" + letter).classList.add("selected");

  document.getElementById("result").innerText = "‚è≥ Ch·ªù k·∫øt qu·∫£...";
  document.getElementById("opponent").innerText = "";

  enableButtons(false);

  socket.send(JSON.stringify({ type: "answer", answer: letter }));
}

function showResult(data) {
  clearInterval(timerInterval);
  timerInterval = null;
  document.getElementById("timer").innerText = "";

  // Update scores with usernames
  const scoresDiv = document.getElementById("scores");
  if (data.scores) {
    let scoresText = "ƒêi·ªÉm ‚Üí ";
    const scores = [];
    
    playersInRoom.forEach((username, userId) => {
      // Scores from backend use string keys
      const score = data.scores[String(userId)] || data.scores[userId] || 0;
      const isMe = userId === myUserId;
      scores.push(`${username}${isMe ? ' (B·∫°n)' : ''}: ${score}`);
    });
    
    scoresDiv.innerText = scoresText + scores.join(" | ");
    scoresDiv.style.display = "block";
  }

  document.getElementById("opponent").innerText = "";

  const correctLetter = data.correct_answer;

  if (correctLetter) {
    const correctBtn = document.getElementById("btn" + correctLetter);
    if (correctBtn) correctBtn.classList.add("correct");
  }

  let resultMsg = data.message || "";
  if (myAnswer) {
    const playerBtn = document.getElementById("btn" + myAnswer);
    if (myAnswer === correctLetter) {
      playerBtn.classList.remove("selected");
      playerBtn.classList.add("correct");
      resultMsg = "‚úÖ ƒê√∫ng r·ªìi! +1 ƒëi·ªÉm";
    } else {
      playerBtn.classList.remove("selected");
      playerBtn.classList.add("wrong");
      resultMsg = "‚ùå Sai r·ªìi...";
    }
  } else {
    resultMsg = "‚è∞ H·∫øt gi·ªù! ƒê√°p √°n ƒë√∫ng: " + correctLetter;
  }

  document.getElementById("result").innerText = resultMsg;
}
function stopClientTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    document.getElementById("timer").innerText = "";
}
function showFinalResult(data) {
  // Clear any existing timer
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  enableButtons(false);

  const scores = data.scores || {};
  const scoresWithNames = data.scores_with_names || {};
  
  // T√¨m ng∆∞·ªùi th·∫Øng
  let maxScore = -1;
  let winners = [];
  
  playersInRoom.forEach((username, userId) => {
    // Scores from backend use string keys
    const score = scores[String(userId)] || scores[userId] || 0;
    if (score > maxScore) {
      maxScore = score;
      winners = [{ userId, username }];
    } else if (score === maxScore) {
      winners.push({ userId, username });
    }
  });

  let winner = "ü§ù H√íA";
  let winnerColor = "#fbbf24";
  
  if (winners.length === 1) {
    const isMe = winners[0].userId === myUserId;
    winner = isMe ? "üèÜ B·∫†N TH·∫ÆNG!" : `üèÜ ${winners[0].username.toUpperCase()} TH·∫ÆNG`;
    winnerColor = isMe ? "#22c55e" : "#3b82f6";
  }

  document.getElementById("question").innerText = "üèÅ TR·∫¨N ƒê·∫§U K·∫æT TH√öC";
  document.getElementById("timer").innerText = "";
  document.getElementById("opponent").innerText = "";

  document.getElementById("result").innerText = winner;
  document.getElementById("result").style.color = winnerColor;
  document.getElementById("result").style.fontSize = "24px";

  // Show final scores
  const scoresArray = [];
  playersInRoom.forEach((username, userId) => {
    // Scores from backend use string keys
    const score = scores[String(userId)] || scores[userId] || 0;
    const isMe = userId === myUserId;
    scoresArray.push(`${username}${isMe ? ' (B·∫°n)' : ''}: ${score}`);
  });

  document.getElementById("scores").innerText = 
    `K·∫æT QU·∫¢ CU·ªêI ‚Üí ${scoresArray.join(" | ")}`;
  document.getElementById("scores").style.display = "block";
}

function setBtn(letter, text) {
  document.getElementById("btn" + letter).innerText = `${letter}. ${text || "(tr·ªëng)"}`;
}

function enableButtons(enable) {
  ["A","B","C","D"].forEach(l => document.getElementById("btn" + l).disabled = !enable);
}

// Initial connection
connect();
</script>

</body>
</html>