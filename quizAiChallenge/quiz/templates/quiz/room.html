<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Battle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    .box {
      background: #020617;
      border-radius: 10px;
      padding: 20px;
      max-width: 520px;
      margin: 40px auto;
      box-shadow: 0 0 15px rgba(0,0,0,.6);
    }
    h2 { margin-bottom: 10px; }

    .option {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      font-weight: 500;
      border: 2px solid transparent;
    }
    .option:hover:not(:disabled) {
      background: #334155;
    }
    .option:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .correct { background: #22c55e !important; color: white !important; border-color: #16a34a !important; }
    .wrong { background: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
    .selected { border: 3px solid #60a5fa !important; box-shadow: 0 0 12px #60a5fa; }

    #timer { font-size: 18px; margin: 15px 0; color: #38bdf8; }
    #result { margin-top: 15px; font-size: 19px; min-height: 30px; font-weight: bold; color: #fbbf24; }
    #opponent { color: #fb923c; min-height: 22px; margin: 8px 0; font-weight: bold; }
    #scores { margin-top: 20px; font-size: 18px; display: none; font-weight: bold; color: #a3e635; }
    .debug { font-size: 11px; color: #64748b; margin-top: 15px; }
  </style>
</head>
<body>

<div class="box">
  <h2>Quiz Battle üéØ</h2>

  <div>Room Code: <b id="room"></b></div>
  <div>Your role: <b id="player">-</b></div>

  <hr>

  <div id="question" aria-live="assertive">Waiting for players...</div>
  <div id="timer" aria-live="polite"></div>

  <button class="option" id="btnA" onclick="sendAnswer('A')"></button>
  <button class="option" id="btnB" onclick="sendAnswer('B')"></button>
  <button class="option" id="btnC" onclick="sendAnswer('C')"></button>
  <button class="option" id="btnD" onclick="sendAnswer('D')"></button>

  <div id="opponent" aria-live="polite"></div>
  <div id="result" aria-live="polite"></div>
  <div id="scores"></div>
  
  <div class="debug" id="debug">Connecting...</div>
</div>

<script>
const roomCode = window.location.pathname.split("/").filter(Boolean).pop();
document.getElementById("room").innerText = roomCode || "Unknown";

let socket;
let myPlayer = null;
let currentQuestionNum = 0;
let timerInterval = null;
let answered = false;
let myAnswer = null;

function debug(msg) {
  console.log("Debug: " + msg);
  document.getElementById("debug").innerText = msg;
}

function connect() {
  const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  socket = new WebSocket(`${protocol}//${window.location.host}/ws/quiz/${roomCode}/`);

  socket.onopen = () => debug("Connected");

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("WS:", data);

    switch (data.type) {
      case "joined":
        myPlayer = data.player_label;
        document.getElementById("player").innerText = myPlayer.toUpperCase();
        break;

      case "start":
        startQuestion(data);
        break;

      case "player_answered":
        if (data.player_label !== myPlayer && !answered) {
          document.getElementById("opponent").innerText = "‚ö° ƒê·ªëi th·ªß ƒë√£ tr·∫£ l·ªùi!";
        }
        break;

      case "result":
        if (data.question_num >= currentQuestionNum) {
          currentQuestionNum = data.question_num;
          showResult(data);
        }
        break;

      case "finished":
        showFinalResult(data);
        break;
    }
  };

  socket.onclose = () => {
    debug("Disconnected - reconnecting...");
    setTimeout(connect, 3000);
  };
}

function startQuestion(data) {
  currentQuestionNum = data.question_num;
  answered = false;
  myAnswer = null;

  clearInterval(timerInterval);

  document.getElementById("question").innerText = `C√¢u ${data.question_num}: ${data.question.text}`;

  ["A","B","C","D"].forEach(l => {
    setBtn(l, data.question[l.toLowerCase()] || "");
    const btn = document.getElementById("btn" + l);
    btn.classList.remove("correct", "wrong", "selected");
  });

  document.getElementById("result").innerText = "";
  document.getElementById("opponent").innerText = "";
  document.getElementById("scores").style.display = "none";

  enableButtons(true);
  startTimer(data.timer || 30);
}

function startTimer(seconds) {
  let time = seconds;
  document.getElementById("timer").innerText = `‚è± ${time}s`;
  timerInterval = setInterval(() => {
    time--;
    document.getElementById("timer").innerText = `‚è± ${time}s`;
    if (time <= 0) {
      clearInterval(timerInterval);
      document.getElementById("timer").innerText = "‚è∞ H·∫øt gi·ªù!";
      enableButtons(false);
      if (!answered) {
        myAnswer = null; // Timed out
        document.getElementById("result").innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
      }
    }
  }, 1000);
}

function sendAnswer(letter) {
  if (answered) return;

  answered = true;
  myAnswer = letter;

  clearInterval(timerInterval);
  document.getElementById("timer").innerText = "‚è≥ ƒêang ch·ªù...";

  // Immediate selection highlight
  ["A","B","C","D"].forEach(l => document.getElementById("btn" + l).classList.remove("selected"));
  document.getElementById("btn" + letter).classList.add("selected");

  document.getElementById("result").innerText = "‚è≥ Ch·ªù k·∫øt qu·∫£...";
  document.getElementById("opponent").innerText = "";

  enableButtons(false);

  socket.send(JSON.stringify({ type: "answer", answer: letter }));
}

function showResult(data) {
  clearInterval(timerInterval);
  document.getElementById("timer").innerText = "";

  // Update scores
  document.getElementById("scores").innerText = 
    `ƒêi·ªÉm ‚Üí Player1: ${data.scores.player1} | Player2: ${data.scores.player2}`;
  document.getElementById("scores").style.display = "block";

  document.getElementById("opponent").innerText = "";

  const correctLetter = data.correct_answer;

  // Highlight correct answer
  if (correctLetter) {
    const correctBtn = document.getElementById("btn" + correctLetter);
    if (correctBtn) correctBtn.classList.add("correct");
  }

  // Handle player's answer
  let resultMsg = data.message || "";
  if (myAnswer) {
    const playerBtn = document.getElementById("btn" + myAnswer);
    if (myAnswer === correctLetter) {
      playerBtn.classList.remove("selected");
      playerBtn.classList.add("correct");
      resultMsg = "‚úÖ ƒê√∫ng r·ªìi! +1 ƒëi·ªÉm";
    } else {
      playerBtn.classList.remove("selected");
      playerBtn.classList.add("wrong");
      resultMsg = "‚ùå Sai r·ªìi...";
    }
  } else {
    resultMsg = "‚è∞ H·∫øt gi·ªù! ƒê√°p √°n ƒë√∫ng: " + correctLetter;
  }

  document.getElementById("result").innerText = resultMsg;
}

function showFinalResult(data) {
  clearInterval(timerInterval);
  enableButtons(false);

  const p1 = data.scores.player1;
  const p2 = data.scores.player2;

  let winner = "ü§ù H√íA";
  if (p1 > p2) winner = myPlayer === "player1" ? "üèÜ B·∫†N TH·∫ÆNG!" : "üèÜ PLAYER 1 TH·∫ÆNG";
  else if (p2 > p1) winner = myPlayer === "player2" ? "üèÜ B·∫†N TH·∫ÆNG!" : "üèÜ PLAYER 2 TH·∫ÆNG";

  document.getElementById("question").innerText = "üèÅ TR·∫¨N ƒê·∫§U K·∫æT TH√öC";
  document.getElementById("timer").innerText = "";
  document.getElementById("opponent").innerText = "";

  document.getElementById("result").innerText = winner;
  document.getElementById("result").style.color = p1 !== p2 ? "#22c55e" : "#fbbf24";
  document.getElementById("result").style.fontSize = "24px";

  document.getElementById("scores").innerText = 
    `K·∫æT QU·∫¢ CU·ªêI ‚Üí Player1: ${p1} | Player2: ${p2}`;
  document.getElementById("scores").style.display = "block";
}

function setBtn(letter, text) {
  document.getElementById("btn" + letter).innerText = `${letter}. ${text || "(tr·ªëng)"}`;
}

function enableButtons(enable) {
  ["A","B","C","D"].forEach(l => document.getElementById("btn" + l).disabled = !enable);
}

connect();
</script>

</body>
</html>