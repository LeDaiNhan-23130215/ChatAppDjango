<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Battle</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      text-align: center;
      padding: 20px;
    }
    .box {
      background: #020617;
      border-radius: 10px;
      padding: 20px;
      max-width: 520px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0,0,0,.6);
    }
    h2 { margin-bottom: 10px; }

    .option {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .option:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    #timer {
      font-size: 18px;
      margin: 10px 0;
      color: #38bdf8;
    }

    #result {
      margin-top: 10px;
      font-size: 18px;
      min-height: 26px;
    }

    #opponent {
      color: orange;
      min-height: 22px;
      margin-top: 5px;
    }

    #scores {
      margin-top: 15px;
      font-size: 16px;
      display: none;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>Quiz Battle</h2>

  <div>Room Code: <b id="room"></b></div>
  <div>Your role: <b id="player">-</b></div>

  <hr>

  <div id="question">Waiting for players...</div>
  <div id="timer"></div>

  <button class="option" id="btnA" onclick="sendAnswer('A')"></button>
  <button class="option" id="btnB" onclick="sendAnswer('B')"></button>
  <button class="option" id="btnC" onclick="sendAnswer('C')"></button>
  <button class="option" id="btnD" onclick="sendAnswer('D')"></button>

  <div id="opponent"></div>
  <div id="result"></div>
  <div id="scores"></div>
</div>

<script>
/* ================= STATE ================= */
const roomCode = window.location.pathname.split("/").filter(Boolean).pop();
document.getElementById("room").innerText = roomCode;

let socket;
let myPlayer = null;
let currentQuestionNum = 0;
let timerInterval = null;
let answered = false;

/* ================= CONNECT ================= */
function connect() {
  socket = new WebSocket(`ws://${window.location.host}/ws/quiz/${roomCode}/`);

  socket.onopen = () => {
    console.log("‚úÖ WS connected");
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("‚¨áÔ∏è WS:", data);

    switch (data.type) {
      case "joined":
        myPlayer = data.player_label;
        document.getElementById("player").innerText = myPlayer;
        break;

      case "start":
        startQuestion(data);
        break;

      case "player_answered":
        if (data.player_label !== myPlayer) {
          document.getElementById("opponent").innerText =
            "‚ö° ƒê·ªëi th·ªß ƒë√£ tr·∫£ l·ªùi";
        }
        break;

      case "result":
        if (data.question_num !== currentQuestionNum) return;
        showResult(data);
        break;

      case "finished":
        showFinalResult(data);
        break;
    }
  };

  socket.onclose = () => {
    console.warn("‚ùå WS closed");
  };
}

/* ================= QUESTION ================= */
function startQuestion(data) {
  currentQuestionNum = data.question_num;
  answered = false;

  clearInterval(timerInterval);

  document.getElementById("question").innerText =
    `Q${data.question_num}: ${data.question.text}`;

  setBtn("A", data.question.a);
  setBtn("B", data.question.b);
  setBtn("C", data.question.c);
  setBtn("D", data.question.d);

  document.getElementById("result").innerText = "";
  document.getElementById("opponent").innerText = "";
  document.getElementById("scores").style.display = "none";

  enableButtons(true);
  startTimer(data.timer);
}

/* ================= TIMER ================= */
function startTimer(seconds) {
  let time = seconds;
  document.getElementById("timer").innerText = `‚è± ${time}s`;

  timerInterval = setInterval(() => {
    time--;
    document.getElementById("timer").innerText = `‚è± ${time}s`;

    if (time <= 0) {
      clearInterval(timerInterval);
      enableButtons(false);
    }
  }, 1000);
}

/* ================= ANSWER ================= */
function sendAnswer(letter) {
  if (answered) return;
  answered = true;

  enableButtons(false);

  socket.send(JSON.stringify({
    type: "answer",
    answer: letter
  }));

  document.getElementById("result").innerText = "‚è≥ Ch·ªù ƒë·ªëi th·ªß...";
}

/* ================= RESULT (PER QUESTION) ================= */
function showResult(data) {
  clearInterval(timerInterval);

  document.getElementById("result").innerText = data.message;
  document.getElementById("scores").innerText =
    `Score ‚Üí Player1: ${data.scores.player1} | Player2: ${data.scores.player2}`;
  document.getElementById("scores").style.display = "block";

  enableButtons(false);
}

/* ================= FINAL RESULT ================= */
function showFinalResult(data) {
  clearInterval(timerInterval);
  enableButtons(false);

  const p1 = data.scores.player1;
  const p2 = data.scores.player2;

  let winner = "ü§ù H√íA";
  if (p1 > p2) winner = "üèÜ PLAYER 1 TH·∫ÆNG";
  else if (p2 > p1) winner = "üèÜ PLAYER 2 TH·∫ÆNG";

  document.getElementById("question").innerText = "üèÅ K·∫æT TH√öC TR·∫¨N ƒê·∫§U";
  document.getElementById("timer").innerText = "";
  document.getElementById("opponent").innerText = "";

  document.getElementById("result").innerText = winner;
  document.getElementById("scores").innerText =
    `FINAL SCORE ‚Üí Player1: ${p1} | Player2: ${p2}`;
  document.getElementById("scores").style.display = "block";
}

/* ================= UTILS ================= */
function setBtn(letter, text) {
  document.getElementById("btn" + letter).innerText =
    `${letter}. ${text}`;
}

function enableButtons(enable) {
  ["A","B","C","D"].forEach(l => {
    document.getElementById("btn" + l).disabled = !enable;
  });
}

/* ================= START ================= */
connect();
</script>

</body>
</html>
