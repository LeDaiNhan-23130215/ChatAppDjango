<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chá»n nghÄ©a</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'minigames/style.css' %}">
</head>
<body>
  <div class="mcq-wrapper">

    <!-- Header -->
    <header class="mcq-header">
      <a href="{% url 'homepage' %}" class="back-home">â† Trang chá»§</a>

      <div class="mcq-progress">
        <span id="count">0/0</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
    </header>

    <!-- Game Card -->
    <div id="game" class="mcq-card">
      <div id="prompt" class="mcq-prompt"></div>

      <ul id="choices" class="mcq-choices" role="listbox"></ul>

      <div id="feedback" class="mcq-feedback"></div>

      <button id="next" class="mcq-next" disabled>
        Tiáº¿p tá»¥c â†’
      </button>
    </div>

  </div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    for (const cookie of document.cookie.split(';')) {
      const c = cookie.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

let sessionId = null;
let startTs = null;
let total = 10;
let count = 0;
let answered = false;

async function start() {
  const res = await fetch("{% url 'minigames:create_session' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ total_questions: total })
  });
  const data = await res.json();
  sessionId = data.session_id;
  await loadNext();
}

async function loadNext() {
  if (count >= total) return finish();

  const res = await fetch(`/minigames/sessions/${sessionId}/next/`);
  if (!res.ok) return finish();

  const feedback = document.getElementById('feedback');
  feedback.className = 'mcq-feedback';
  feedback.innerText = '';

  const q = await res.json();
  startTs = q.start_ts;
  answered = false;

  count++;
  document.getElementById('count').innerText = count + '/' + total;
  document.getElementById('prompt').innerText = q.prompt;

  const ul = document.getElementById('choices');
  ul.innerHTML = '';

  q.choices.forEach(c => {
    const li = document.createElement('li');
    li.tabIndex = 0;
    li.innerText = c.text;
    li.onclick = () => submit(q.question_id, c.id, li);
    li.onkeypress = e => {
      if (e.key === 'Enter') submit(q.question_id, c.id, li);
    };
    ul.appendChild(li);
  });

  document.getElementById('feedback').innerText = '';
  document.getElementById('next').disabled = true;
  document.getElementById('progressFill').style.width =
    (count / total * 100) + '%';
}

async function submit(questionId, choiceId, el) {
  if (answered) return;
  answered = true;

  const res = await fetch(`/minigames/sessions/${sessionId}/answer/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      question_id: questionId,
      choice_id: choiceId,
      start_ts: startTs
    })
  });

  const r = await res.json();
  const feedback = document.getElementById('feedback');
  feedback.className = 'mcq-feedback show ' + (r.correct ? 'correct' : 'wrong');
  feedback.innerText = r.correct ? 'âœ” ChÃ­nh xÃ¡c!' : 'âœ– Sai rá»“i';

  document.querySelectorAll('#choices li').forEach(li => {
    li.classList.add('disabled');
  });

  el.classList.add('selected');

  el.style.fontWeight = 'bold';
  document.getElementById('next').disabled = false;
}

async function finish() {
  const res = await fetch(`/minigames/sessions/${sessionId}/finish/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': csrftoken }
  });

  const r = await res.json();

  document.getElementById('game').innerHTML = `
    <div class="result-card">
      <h2>ğŸ‰ HoÃ n thÃ nh!</h2>

      <div class="result-stats">
        <div class="stat">
          <span>Tá»•ng cÃ¢u</span>
          <strong>${r.total_questions}</strong>
        </div>
        <div class="stat correct">
          <span>ÄÃºng</span>
          <strong>${r.score}</strong>
        </div>
        <div class="stat accuracy">
          <span>Äá»™ chÃ­nh xÃ¡c</span>
          <strong>${r.accuracy}</strong>
        </div>
      </div>

      <div class="result-actions">
        <button onclick="location.reload()">ğŸ”„ ChÆ¡i láº¡i</button>
        <a href="{% url 'homepage' %}" class="secondary">ğŸ  Trang chá»§</a>
      </div>
    </div>
  `;
}

document.getElementById('next').onclick = loadNext;
start();
</script>
</body>
</html>